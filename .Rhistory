library(dplyr)
library(janitor)
library(lubridate)
library(hms)
library(tidyr)
library(stringr)
library(readr)
library(forcats)
library(RcppRoll)
library(dplyr)
library(tibble)
library(bit64)
library(exploratory)
library(ggplot2)
library(ggridges)
library(DBI)
library(tidyverse)
knitr::opts_chunk$set(fig.width = 8, collapse = TRUE, include = FALSE)
library(dplyr)
library(janitor)
library(lubridate)
library(hms)
library(tidyr)
library(stringr)
library(readr)
library(forcats)
library(RcppRoll)
library(dplyr)
library(tibble)
library(bit64)
library(exploratory)
library(ggplot2)
library(ggridges)
library(DBI)
library(tidyverse)
current_working_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
current_working_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(current_working_dir)
batch <- as.integer(Sys.time())
#
db <- 'Data/PUF.db'
con <- dbConnect(RSQLite::SQLite(), db)
SF <- tbl(con, "SummaryFiles")
#
db <- 'Data/PUF.db'
con <- dbConnect(RSQLite::SQLite(), db)
PUF <- tbl(con, "PUF")
SF <- tbl(con, "SummaryFiles")
SF <- tbl(con, "FPMRS")
FPMRS <- SF %>% collect()
View(SF)
View(FPMRS)
FPMRS <- FPMRS_tb %>% collect()
PUF_tb <- tbl(con, "PUF")
SF_tb <- tbl(con, "SummaryFiles")
FPMRS_tb <- tbl(con, "FPMRS")
FPMRS <- FPMRS_tb %>% collect()
View(FPMRS)
FPMRS2 <- read.csv("Data/FPMRS_1269_doctors.csv")
View(FPMRS2)
FPMRS2[1205,]
FPMRS[1205,]
as.data.frame(FPMRS[1205,])
FPMRS2[1205,]
rbind(FPMRS2[1205,],as.data.frame(FPMRS[1205,]))
rbind(unname(FPMRS2[1205,]),unname(as.data.frame(FPMRS[1205,])))
dim(FPMRS2[1205,])
dim(as.data.frame(FPMRS[1205,]))
View(unname(as.data.frame(FPMRS[1205,])))
View(unname(as.data.frame(FPMRS2[1205,])))
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS$NPI) %>%
mutate_at(
vars(
`OpioidPrescribingRate`,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`
), funs(parse_number)) %>% filter(State %nin% excluded_states) %>%
collect()
FPMRS$NPI
unlist( FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% unlist(FPMRS$NPI)) %>%
mutate_at(
vars(
`OpioidPrescribingRate`,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`
), funs(parse_number)) %>% filter(State %nin% excluded_states) %>%
collect()
r <- unlist(FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% r) %>%
mutate_at(
vars(
`OpioidPrescribingRate`,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`
), funs(parse_number)) %>% filter(State %nin% excluded_states) %>%
collect()
?%nin%
%nin%
library(Hmisc)
%nin%
4 %nin% [1,2,3]
4 %nin% c(1,2,3)
r <- unlist(FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% r) %>%
mutate_at(
vars(
`OpioidPrescribingRate`,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`
), funs(parse_number)) %>% filter(State %nin% excluded_states) %>%
collect()
vars(
`OpioidPrescribingRate`,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`
), funs(parse_number)) %>% collect()
OpioidPrescribingRate,
opioidRX <- SF_tb %>%
filter(NPI %in% r) %>%
mutate_at(
vars(
OpioidPrescribingRate,
Extended-ReleaseOpioidClaims,
Extended-ReleaseOpioidPrescribingRate), funs(parse_number)) %>% collect()
opioidRX <- SF_tb %>%
filter(NPI %in% r) %>%
mutate_at(
vars(
OpioidPrescribingRate,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`), funs(parse_number)) %>% collect()
?parse_number
opioidRX <- SF_tb %>%
filter(NPI %in% unlist(FPMRS$NPI)) %>% collect() %>%
mutate_at(
vars(
OpioidPrescribingRate,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`), funs(parse_number))
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
mutate_at(
vars(
OpioidPrescribingRate,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`), funs(parse_number))
FPMRS_NPIs <- unlist(FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
mutate_at(
vars(
OpioidPrescribingRate,
`Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`), funs(parse_number))
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
filter(State %nin% excluded_states) %>%
mutate_at(vars(OpioidPrescribingRate, `Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`),
funs(parse_number)) %>%
mutate_at(vars(Year, NPI, `NPPESProviderLastName`, `NPPESProviderFirstName`,
`Zip`, State, Specialty), funs(factor)) %>%
mutate(RXRate = OpioidClaimCount/TotalClaimCount) %>%
filter(!is.na(RXRate)) %>%
group_by(NPI) %>% mutate(Specialty = "FPMRS")
excluded_states <- c("AA", "AE", "AP", "AS", "GU", "MP", "VI", "ZZ", "XX")
FPMRS_NPIs <- unlist(FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
filter(State %nin% excluded_states) %>%
mutate_at(vars(OpioidPrescribingRate, `Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`),
funs(parse_number)) %>%
mutate_at(vars(Year, NPI, `NPPESProviderLastName`, `NPPESProviderFirstName`,
`Zip`, State, Specialty), funs(factor)) %>%
mutate(RXRate = OpioidClaimCount/TotalClaimCount) %>%
filter(!is.na(RXRate)) %>%
group_by(NPI) %>% mutate(Specialty = "FPMRS")
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
filter(State %nin% excluded_states) %>%
mutate_at(vars(OpioidPrescribingRate, `Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`),
funs(parse_number)) %>%
mutate_at(vars(Year, NPI, `NPPESProviderLastName`, `NPPESProviderFirstName`,
`Zip`, State, Specialty), funs(factor)) %>%
mutate(OpioidClaimCount = as.numeric(OpioidClaimCount)) %>%
mutate(TotalClaimCount = as.numeric(TotalClaimCount)) %>%
mutate(RXRate = OpioidClaimCount/TotalClaimCount) %>%
filter(!is.na(RXRate)) %>%
group_by(NPI) %>% mutate(Specialty = "FPMRS")
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
filter(State %nin% excluded_states) %>%
mutate_at(vars(OpioidPrescribingRate, `Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`),
funs(parse_number)) %>%
mutate_at(vars(Year, NPI, `NPPESProviderLastName`, `NPPESProviderFirstName`,
`Zip`, State, Specialty), funs(factor)) %>%
mutate(OpioidClaimCount = as.numeric(OpioidClaimCount)) %>%
mutate(TotalClaimCount = as.numeric(TotalClaimCount)) %>%
mutate(RXRate = OpioidClaimCount/TotalClaimCount) %>%
filter(!is.na(RXRate)) %>% group_by(NPI) %>% mutate(Specialty = "FPMRS") %>%
group_by(NPI) %>%
mutate(
MedianBySpecialty = median(RXRate, na.rm = TRUE),
`Extended-ReleaseOpioidClaims` = impute_na(
`Extended-ReleaseOpioidClaims`,
type = "value",
val = "0"
),
`Extended-ReleaseOpioidPrescribingRate` = impute_na(
`Extended-ReleaseOpioidPrescribingRate`,
type = "value",
val = "0"
)
) %>% ungroup()
View(opioidRX)
`MPDOPS_2017` <- exploratory::read_delim_file("Data/MPDOPS Files/Medicare_Part_D_Opioid_Prescriber_Summary_File_2017.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale = readr::locale(encoding = "UTF-8", decimal_mark = ".", tz = "America/New_York", grouping_mark = "," ), trim_ws = TRUE , progress = FALSE) %>%
readr::type_convert(.) %>%
rename(`Extended-Release Opioid Prescribing Rate` = `Long-Acting Opioid Prescribing Rate`) %>%
rename(`Extended-Release Opioid Claims` = `Long-Acting Opioid Claim Count`) %>%
exploratory::clean_data_frame(.)
`MPDOPS_2016` <- exploratory::read_delim_file("Data/MPDOPS Files/Medicare_Part_D_Opioid_Prescriber_Summary_File_2016.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale = readr::locale(encoding = "UTF-8", decimal_mark = ".", tz = "America/New_York", grouping_mark = "," ), trim_ws = TRUE , progress = FALSE) %>%
readr::type_convert(.) %>%
exploratory::clean_data_frame(.)
`MPDOPS_2015` <- exploratory::read_delim_file("Data/MPDOPS Files/Medicare_Part_D_Opioid_Prescriber_Summary_File_2015.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale = readr::locale(encoding = "UTF-8", decimal_mark = ".", tz = "America/New_York", grouping_mark = "," ), trim_ws = TRUE , progress = FALSE) %>%
readr::type_convert(.) %>%
exploratory::clean_data_frame(.)
`MPDOPS_2014` <- exploratory::read_delim_file("Data/MPDOPS Files/Medicare_Part_D_Opioid_Prescriber_Summary_File_2014.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale = readr::locale(encoding = "UTF-8", decimal_mark = ".", tz = "America/New_York", grouping_mark = "," ), trim_ws = TRUE , progress = FALSE) %>%
readr::type_convert(.) %>%
exploratory::clean_data_frame(.)
`MPDOPS_2013` <- exploratory::read_delim_file("Data/MPDOPS Files/Medicare_Part_D_Opioid_Prescriber_Summary_File_2013.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale = readr::locale(encoding = "UTF-8", decimal_mark = ".", tz = "America/New_York", grouping_mark = "," ), trim_ws = TRUE , progress = FALSE) %>%
readr::type_convert(.) %>%
exploratory::clean_data_frame(.)
FPMRS <- read.csv("Data/FPMRS_1269_doctors.csv")
MPDOPS <- MPDOPS_2014 %>%
rename(`NPPES Provider ZIP Code` = `NPPES Provider Zip Code`) %>%
rename(`NPPES Provider Last Name` = `NPPES Provider Last/Org Name`) %>%
bind_rows(MPDOPS_2013, MPDOPS_2015, MPDOPS_2016, MPDOPS_2017,
id_column_name = "ID", current_df_name = "MPDOPS_2014",
force_data_type = TRUE
)
opioidRX <-  MPDOPS %>%
mutate_at(vars(`Opioid Prescribing Rate`,
`Extended-Release Opioid Prescribing Rate`),
funs(parse_number)) %>%
mutate_at(vars(ID, NPI, `NPPES Provider Last Name`,
`NPPES Provider First Name`, `NPPES Provider ZIP Code`,
`NPPES Provider State`, `Specialty Description`),
funs(factor)) %>% arrange(desc(NPI)) %>%
mutate(`Specialty Description` = factor(`Specialty Description`)) %>%
filter(NPI %in% FPMRS$NPI) %>%
mutate(RXRate = `Opioid Claim Count`/`Total Claim Count`) %>%
filter(!is.na(RXRate)) %>%
rename(Specialty = `Specialty Description`) %>%
mutate(Specialty = factor(Specialty)) %>%
rename(State = `NPPES Provider State`) %>%
mutate(State = factor(State)) %>%
mutate(`NPPES Provider ZIP Code` = factor(`NPPES Provider ZIP Code`)) %>%
rename(Zip = `NPPES Provider ZIP Code`) %>%
filter(State %nin% c("AA", "AE", "AP", "AS", "GU", "MP", "VI", "ZZ", "XX")) %>%
mutate(State = fct_drop(State)) %>%
group_by(NPI) %>% mutate(Specialty = "FPMRS") %>%
mutate(MedianBySpecialty = median(RXRate, na.rm = TRUE),
`Extended-Release Opioid Claims` = impute_na(`Extended-Release Opioid Claims`, type = "value", val = "0"),
`Extended-Release Opioid Prescribing Rate` = impute_na(`Extended-Release Opioid Prescribing Rate`,
type = "value", val = "0")) %>%
rename(Year = ID) %>%
mutate_at(vars(`Opioid Claim Count`, `Opioid Prescribing Rate`,
`Extended-Release Opioid Claims`,
`Extended-Release Opioid Prescribing Rate`),
funs(parse_number)) %>%
ungroup()
rmd_total_fpmrs <- opioidRX %>% select(NPI) %>% unique() %>% ungroup() %>%
count() %>% unlist(use.names = FALSE)
rmd_fpmrs_data <- opioidRX %>% group_by(NPI) %>%
summarise(`Opioid Claim Count` = round(mean(`Opioid Claim Count`),0)) %>% ungroup() %>% summarise(
LE10 = sum(`Opioid Claim Count` <= 10),
GT10 = sum(`Opioid Claim Count` > 10)) %>%
mutate(P_LE10 = round(100*LE10/(LE10 + GT10),0),
P_GT10 = round(100*GT10/(LE10 + GT10),0))
fpmrs_GE10 <- opioidRX %>% group_by(NPI) %>%
summarise(`Opioid Claim Count` = round(mean(`Opioid Claim Count`),0)) %>% ungroup() %>% filter(`Opioid Claim Count` >= 10) %>%
select(NPI) %>% unique() %>% ungroup() %>%
unlist(use.names = FALSE)
current_working_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(current_working_dir)
batch <- as.integer(Sys.time())
#
db <- 'Data/PUF.db'
con <- dbConnect(RSQLite::SQLite(), db)
PUF_tb <- tbl(con, "PUF")
SF_tb <- tbl(con, "SummaryFiles")
FPMRS_tb <- tbl(con, "FPMRS")
FPMRS <- FPMRS_tb %>% collect()
excluded_states <- c("AA", "AE", "AP", "AS", "GU", "MP", "VI", "ZZ", "XX")
FPMRS_NPIs <- unlist(FPMRS$NPI)
opioidRX <- SF_tb %>%
filter(NPI %in% FPMRS_NPIs) %>% collect() %>%
filter(State %nin% excluded_states) %>%
mutate_at(vars(OpioidPrescribingRate, `Extended-ReleaseOpioidClaims`,
`Extended-ReleaseOpioidPrescribingRate`),
funs(parse_number)) %>%
mutate_at(vars(Year, NPI, `NPPESProviderLastName`, `NPPESProviderFirstName`,
`Zip`, State, Specialty), funs(factor)) %>%
mutate(OpioidClaimCount = as.numeric(OpioidClaimCount)) %>%
mutate(TotalClaimCount = as.numeric(TotalClaimCount)) %>%
mutate(RXRate = OpioidClaimCount/TotalClaimCount) %>%
filter(!is.na(RXRate)) %>% group_by(NPI) %>% mutate(Specialty = "FPMRS") %>%
group_by(NPI) %>%
mutate(
MedianBySpecialty = median(RXRate, na.rm = TRUE),
`Extended-ReleaseOpioidClaims` = impute_na(
`Extended-ReleaseOpioidClaims`,
type = "value",
val = "0"
),
`Extended-ReleaseOpioidPrescribingRate` = impute_na(
`Extended-ReleaseOpioidPrescribingRate`,
type = "value",
val = "0"
)
) %>% ungroup()
rmd_total_fpmrs <- opioidRX %>% select(NPI) %>% unique() %>% ungroup() %>%
count() %>% unlist(use.names = FALSE)
rmd_fpmrs_data <- opioidRX %>% group_by(NPI) %>%
summarise(`Opioid Claim Count` = round(mean(`Opioid Claim Count`),0)) %>% ungroup() %>% summarise(
LE10 = sum(`Opioid Claim Count` <= 10),
GT10 = sum(`Opioid Claim Count` > 10)) %>%
mutate(P_LE10 = round(100*LE10/(LE10 + GT10),0),
P_GT10 = round(100*GT10/(LE10 + GT10),0))
rmd_total_fpmrs <- opioidRX %>% select(NPI) %>% unique() %>% ungroup() %>%
count() %>% unlist(use.names = FALSE)
rmd_fpmrs_data <- opioidRX %>% group_by(NPI) %>%
summarise(OpioidClaimCount = round(mean(OpioidClaimCount),0)) %>% ungroup() %>% summarise(
LE10 = sum(OpioidClaimCount <= 10),
GT10 = sum(OpioidClaimCount > 10)) %>%
mutate(P_LE10 = round(100*LE10/(LE10 + GT10),0),
P_GT10 = round(100*GT10/(LE10 + GT10),0))
fpmrs_GE10 <- opioidRX %>% group_by(NPI) %>%
summarise(OpioidClaimCount = round(mean(OpioidClaimCount),0)) %>% ungroup() %>% filter(OpioidClaimCount >= 10) %>%
select(NPI) %>% unique() %>% ungroup() %>%
unlist(use.names = FALSE)
fpmrs_GE10_PUF_13 <- PUF_13 %>% filter(NPI %in% fpmrs_GE10) %>% collect()
claims <- PUF %>% filter(NPI %in% fpmrs_GE10) %>% collect()
claims <- PUF_tb %>% filter(NPI %in% fpmrs_GE10) %>% collect()
View(claims)
head(PUF_tb)
claims <- PUF_tb %>% filter(npi %in% fpmrs_GE10) %>% collect()
fpmrs_GE10
